# üß™ Observability Toolkit: Telemetry at High Fidelity

> **Document Level:** Architect (15+ years experience)  
> **Focus:** Micrometer Internals, OpenTelemetry (OTel), Distributed Tracing, and Cardinality Management

---

## üèóÔ∏è Layer 1: The Metrics Masterclass - Micrometer

Micrometer is the SLF4J of metrics. It provides a vendor-neutral facade over Prometheus, Datadog, etc.

### 1. Metric Types & Architectural Choice
-   **Counter**: Increments only (Requests per minute). 
-   **Gauge**: Current level (Memory used, Active threads). 
-   **Timer**: Records latency + throughput (p95, p99).
-   **Distribution Summary**: For tracking things like "Order Value" or "Payload Size".

### 2. The Cardinality Explosion Problem
- **The Issue**: If you add a `user_id` tag to a metric, and you have 1 million users, Prometheus will try to store 1 million unique time-series. This will **crash your monitoring server**.
- **Architect Rule**: Only use "High-Cardinality" data (like IDs or UUIDs) in **Logs or Traces**, never in **Metrics**.

---

## üõ†Ô∏è Layer 2: Distributed Tracing - OpenTelemetry (OTel)

Tracing tracks a single request as it jumps across microservices.

### 1. Context Propagation
How does Service B know it's part of a trace started by Service A?
- **W3C TraceContext**: The modern standard. It uses two headers: `traceparent` (Trace ID) and `tracestate` (Vendor metadata).
- **B3 Propagation**: The older Zipkin standard (X-B3-TraceId).

### 2. Sampling Strategies
Tracing every request in a system doing 100k req/sec is expensive.
- **Head Sampling**: Deciding at the start of the trace whether to record it.
- **Adaptive Sampling**: Increasing sampling during errors and decreasing it during normal traffic.

---

## üöÄ Layer 3: High-Resolution Logging (Structured JSON)

Human-readable logs are for debugging. JSON logs are for **Engineering Analysis**.

### 1. The MDC (Mapped Diagnostic Context)
A `ThreadLocal` map provided by SLF4J/Logback.
- **Pattern**: Store the `trace_id` and `customer_id` in the MDC at the start of the request. Every log line emitted by that thread will automatically include those IDs.
- **Architect Benefit**: You can instantly search Kibana/Splunk for every log generated by a specific customer, even if it happened across 10 machines.

---

## üìú Layer 4: The Profiling Sandbox

### 1. Continuous Profiling
Modern SREs don't profile only during bugs; they profile **All the time**.
- **Tool**: **Pyroscope** or **GCP Cloud Profiler**. 
- **Internal**: Uses **JFR** or **Async-Profiler** to send 10-second snippets of CPU/Memory data every few minutes.
- **Benefit**: You can see that a recent PR increased CPU usage by 5% *before* it becomes a production incident.

---

## üèÅ Layer 5: Dashboarding for Architects

An architect doesn't look at "CPU %". They look at the **"Four Golden Signals"**:
1.  **Latency**: Time to service a request.
2.  **Traffic**: How much demand is placed on the system.
3.  **Errors**: Rate of failed requests.
4.  **Saturation**: How "Full" your service is (e.g., Thread pool utilization).

---

## üß≠ Interview Prep & Architect Scenarios

### Q: Why choose OpenTelemetry over vendor-specific SDKs?
**A**: **Portability**. If you use the OTel SDK, you can switch from Prometheus to Datadog simply by changing a configuration URL, without rewriting any code. It also prevents "Vendor Lock-in".

### Q: Explain "Log-based Metrics".
**A**: Instead of instrumenting code, you extract metrics from logs (e.g., "Count lines containing ERROR"). This is a "Rear-view mirror" approach. Modern architects prefer "Active Instrumentation" (Micrometer) for real-time accuracy and "Logging" for context.

---

## üß≠ Navigation

| Direction | File | Description |
| :--- | :--- | :--- |
| ‚¨ÖÔ∏è **Back** | [22-enterprise-java-case-studies.md](./22-enterprise-java-case-studies.md) | Case Studies |
| ‚è© **Next** | [24-java-performance-incident-response.md](./24-java-performance-incident-response.md) | Incident Response |

**Author:** Nehru Usare  
**Version:** 2.0 | Expanded February 2026
